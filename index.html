<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>

    <script type="text/javascript">



    class DotCanvas {

      constructor(canvasDOM, options){
        this.canvas = canvasDOM;
        this.context = this.canvas.getContext('2d');
        this.started = false;
        this.context.lineJoin = 'round';
        this.context.lineCap = 'round';
        this.memCanvas = document.createElement('canvas');
        this.memCanvas.width = this.canvas.width;
        this.memCanvas.height = this.canvas.height;
        this.memCtx = this.memCanvas.getContext('2d');
        this.undoHistory = [];

        this.init();
        this.setOptions(options);
        this.canvas.addEventListener('mousedown', this.ev_canvas.bind(this), false);
        this.canvas.addEventListener('mousemove', this.ev_canvas.bind(this), false);
        this.canvas.addEventListener('mouseup', this.ev_canvas.bind(this), false);
        this.canvas.addEventListener('mouseout', this.ev_canvas.bind(this), false);
      }

      setOptions(options){

        this.context.strokeStyle = "#000000";
        this.context.lineWidth = 5;
        this.period = 10;
        this.onFinishLine = null;
        this.onClear = null;

        if(typeof options !== 'object' || options == null) return;

        if(typeof options.color === 'string')
          this.context.strokeStyle = options.color;

        if(typeof options.lineWidth === 'number')
          this.context.lineWidth = options.lineWidth;

        if(typeof options.period === 'number')
          this.period = options.period;

        if(typeof options.onFinishLine === 'function')
          this.onFinishLine = options.onFinishLine;

        if(typeof options.onClear === 'function')
          this.onClear = options.onClear;
      }

      isEmpty(){
        return this.lines.length == 0;
      }

      getLines(){
        return this.lines;
      }

      undo(){
        this.undoHistory.pop();

        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.memCtx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        if(this.undoHistory.length > 0){
          var prev = this.undoHistory[this.undoHistory.length - 1];
          this.context.drawImage(prev, 0, 0);
          this.memCtx.drawImage(prev, 0, 0);
        }

        this.lines.pop();

        if(this.onFinishLine != null)
          this.onFinishLine(this);

      }

      getPrettyLines(){
        var list = [];
        for(var i=0; i<this.lines.length; i++){
          var dots = [];
          for(var j=0; j<this.lines[i][0].length; j++){
            dots.push({
              x: this.lines[i][0][j],
              y: this.lines[i][1][j],
              timestamp: this.lines[i][2][j]
            });
          }
          list.push(dots);
        }
        return list;
      }

      init(){
        this.points = [];
        this.count = 0;
        this.temp = [[], [], []];
        this.lines = [];
        this.firstTimestamp = -1;
      }

      ev_canvas(ev) {
        if (this.getX(ev) || this.getX(ev) == 0) {
          ev._x = this.getX(ev);
          ev._y = this.getY(ev);
        }

        ev._x = ev._x + 0.5;
        var func = this[ev.type].bind(this);
        if (func)
          func(ev);
      }

      addDot(point){
        let x = point.x;
        let y = point.y;
        this.temp[0].push(x);
        this.temp[1].push(y);
        if(this.temp[2].length == 0 && this.lines.length == 0){
          this.temp[2].push(0);
          this.firstTimestamp = new Date().getTime();
        } else {
          this.temp[2].push(new Date().getTime() - this.firstTimestamp);
        }
      }

      finishLine(){
        var canvasCopy = document.createElement('canvas');
        canvasCopy.width = this.canvas.offsetWidth;
        canvasCopy.height = this.canvas.offsetHeight;
        var canvasCopyCtx = canvasCopy.getContext('2d');
        canvasCopyCtx.drawImage(this.canvas, 0, 0);
        this.undoHistory.push(canvasCopy);
        this.lines.push(this.temp);
        this.temp = [[], [], []];
        if(this.onFinishLine != null)
          this.onFinishLine(this);
      }

      getX(ev){
        return ev.offsetX;
      }

      getY(ev){
        return ev.offsetY;
      }

      mousedown(ev) {
        this.count = 0;

        console.log(ev.offsetX + `[0 - ${this.canvas.offsetWidth}]`)


        var point = {
            x: ev._x / this.canvas.offsetWidth,
            y: ev._y / this.canvas.offsetWidth
        };

        this.addDot(point);
        this.drawDot(this.context, point.x, point.y);
        this.memCtx.clearRect(0, 0, this.canvas.offsetWidth, this.canvas.offsetHeight);
        this.memCtx.drawImage(this.canvas, 0, 0);
        this.points.push(point);
        this.started = true;

        this.drawPoints(this.context, this.points);
      }

      mousemove(ev) {
        if (this.started) {
          var point = {
              x: ev._x / this.canvas.offsetWidth,
              y: ev._y / this.canvas.offsetWidth
          };

            this.count++;
            if(this.count == this.period){
              this.addDot(point);
              this.count = 0;
            }
            this.context.clearRect(0, 0, this.canvas.offsetWidth, this.canvas.offsetHeight);
            this.context.drawImage(this.memCanvas, 0, 0);
            this.points.push(point);
            this.drawPoints(this.context, this.points);
        }
      }

      mouseup(ev) {
        if (this.started) {
            this.started = false;
            this.memCtx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.memCtx.drawImage(this.canvas, 0, 0);
            this.points = [];

            var point = {
                x: ev._x / this.canvas.offsetWidth,
                y: ev._y / this.canvas.offsetWidth
            };

            this.addDot(point);
            this.finishLine();
        }
      }

      mouseout(ev){
        this.mouseup(ev);
      }

      clear() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.memCtx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.undoHistory = [];
        this.init();

        if(this.onClear != null)
          this.onClear();
      }

      drawDot(ctx, x, y){
        ctx.beginPath();
        ctx.arc(x * this.canvas.width, y * this.canvas.width, ctx.lineWidth/2, 0, 2 * Math.PI, false);
        ctx.fillStyle = ctx.strokeStyle;
        ctx.fill();
      }

      drawPoints(ctx, points) {
        ctx.beginPath();


        ctx.moveTo(points[0].x * this.canvas.width, points[0].y * this.canvas.width);
        for (var i = 1; i < points.length - 2; i++) {
            var c = ((points[i].x* this.canvas.width) + (points[i + 1].x* this.canvas.width)) / 2,
                d = ((points[i].y * this.canvas.width) + (points[i + 1].y * this.canvas.width)) / 2;
            ctx.quadraticCurveTo(points[i].x * this.canvas.width, points[i].y * this.canvas.width, c, d);
        }
        if(i < points.length - 1){
          ctx.quadraticCurveTo(
            points[i].x * this.canvas.width,
            points[i].y * this.canvas.width,
            points[i + 1].x * this.canvas.width,
            points[i + 1].y * this.canvas.width);
        }
        ctx.stroke();
      }

    }




    </script>
  </head>
  <body>


    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <canvas id="canvas-main" style="border: 1px solid black; width: 100%;" height=500></canvas>
        </div>

        <div class="col-md-6">
          <canvas id="canvas-main2" style="border: 1px solid black; width: 100%;" height=200></canvas>
        </div>
      </div>
    </div>



    <button onclick="canvas.clear()">Clear</button>



    <script>

    canvas = new DotCanvas(document.getElementById("canvas-main"), {
      period: 5,
      lineWidth: 6,
      color: "#404769",

      onFinishLine: function(c){
        console.log(c.lines)
      },

      onClear: function(){
        console.log("Clear")
      }
    });

    canvas2 = new DotCanvas(document.getElementById("canvas-main2"), {
      period: 5,
    });

    //constructor(canvasDOM, options, finishLineCallback, clearCallback){

    </script>

  </body>
</html>
